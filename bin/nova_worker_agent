#!/usr/bin/env ruby
# frozen_string_literal: true

$stdout.sync = true

require 'base64'
require 'json'
require_relative '../lib/saturn_ci_worker_api/request'
require_relative '../lib/saturn_ci_worker_api/stream'

host = ENV.fetch('SATURNCI_API_HOST')
task_id = ENV.fetch('TASK_ID')

def log_direct(host, task_id, message)
  SaturnCIWorkerAPI::Request.new(
    host: host,
    method: :post,
    endpoint: "tasks/#{task_id}/system_logs",
    body: Base64.encode64("#{message}\n"),
    content_type: 'text/plain'
  ).execute
end

log_direct(host, task_id, 'Worker started. Checking /var/log/syslog...')

syslog_path = '/var/log/syslog'
if File.exist?(syslog_path)
  line_count = File.readlines(syslog_path).count
  log_direct(host, task_id, "/var/log/syslog exists. Line count: #{line_count}")
else
  log_direct(host, task_id, '/var/log/syslog does NOT exist!')
end

log_direct(host, task_id, 'Starting stream and waiting 5 seconds...')

syslog_stream = SaturnCIWorkerAPI::Stream.new(
  syslog_path,
  "tasks/#{task_id}/system_logs",
  wait_interval: 1
)
syslog_stream.start
sleep 5

log_direct(host, task_id, 'Sleep done. Now trying puts...')

puts "Hello from K8s worker! Task ID: \"#{task_id}\""

response = SaturnCIWorkerAPI::Request.new(
  host: host,
  method: :get,
  endpoint: "tasks/#{task_id}"
).execute

task_info = JSON.parse(response.body)

puts <<~OUTPUT
  Task info received:
    github_repo_full_name: #{task_info['github_repo_full_name']}
    branch_name: #{task_info['branch_name']}
    commit_hash: #{task_info['commit_hash']}
    github_installation_id: #{task_info['github_installation_id']}
    rspec_seed: #{task_info['rspec_seed']}
    run_order_index: #{task_info['run_order_index']}
    number_of_concurrent_runs: #{task_info['number_of_concurrent_runs']}
    env_vars: [#{task_info['env_vars'].keys.join(', ')}]
OUTPUT

sleep 2
syslog_stream.kill
