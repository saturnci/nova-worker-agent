#!/usr/bin/env ruby
# frozen_string_literal: true

require 'base64'
require 'json'
require_relative '../lib/saturn_ci_worker_api/request'
require_relative '../lib/saturn_ci_worker_api/stream'

host = ENV.fetch('SATURNCI_API_HOST')
task_id = ENV.fetch('TASK_ID')

LOG_PATH = '/tmp/output.log'
File.write(LOG_PATH, '')
$stdout.reopen(LOG_PATH, 'a')
$stdout.sync = true

syslog_stream = SaturnCIWorkerAPI::Stream.new(
  LOG_PATH,
  "tasks/#{task_id}/system_logs",
  wait_interval: 1
)
syslog_stream.start
sleep 1

puts "Hello from K8s worker! Task ID: \"#{task_id}\""

response = SaturnCIWorkerAPI::Request.new(
  host: host,
  method: :get,
  endpoint: "tasks/#{task_id}"
).execute

task_info = JSON.parse(response.body)

puts <<~OUTPUT
  Task info received:
    github_repo_full_name: #{task_info['github_repo_full_name']}
    branch_name: #{task_info['branch_name']}
    commit_hash: #{task_info['commit_hash']}
    github_installation_id: #{task_info['github_installation_id']}
    rspec_seed: #{task_info['rspec_seed']}
    run_order_index: #{task_info['run_order_index']}
    number_of_concurrent_runs: #{task_info['number_of_concurrent_runs']}
    env_vars: [#{task_info['env_vars'].keys.join(', ')}]
OUTPUT

sleep 2
syslog_stream.kill
