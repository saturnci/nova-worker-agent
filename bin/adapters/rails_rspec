#!/usr/bin/env ruby
# frozen_string_literal: true

require 'English'
require 'fileutils'
require_relative '../../lib/executor'
require_relative '../../lib/dry_run'
require_relative '../../lib/saturn_ci_worker_api/request'
require_relative '../../lib/saturn_ci_worker_api/stream'
require_relative '../../lib/saturn_ci_worker_api/file_content_request'

DOCKER_SERVICE_NAME = 'saturn_test_app'

executor = Executor.new
executor.start_stream

begin
  puts 'Adapter: Ruby on Rails/Rspec'

  executor.clone_repo
  executor.write_env_file

  puts 'Copying database.yml...'
  FileUtils.cp('.saturnci/database.yml', 'config/database.yml')

  executor.wait_for_docker
  executor.authenticate_to_registry_cache

  puts 'Building with cache...'
  executor.build_with_cache

  task_info = executor.task_info
  image_url = "docker-image-registry.saturnci.com:5000/#{task_info['project_name']&.downcase}"

  puts 'Pulling image from registry...'
  system("docker pull #{image_url}:latest 2>&1")

  puts 'Running pre.sh...'
  system('chmod +x .saturnci/pre.sh')
  system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest docker-compose -f .saturnci/docker-compose.yml run #{DOCKER_SERVICE_NAME} ./.saturnci/pre.sh 2>&1")

  puts 'Running dry run...'
  dry_run = DryRun.new(docker_service_name: DOCKER_SERVICE_NAME, image_url: "#{image_url}:latest")
  puts "Running dry run command: #{dry_run.command}"
  example_count = dry_run.expected_count
  puts "Expected test count: #{example_count}"

  test_suite_run_id = task_info['test_suite_run_id']
  puts "Setting dry_run_example_count to #{example_count} for test_suite_run #{test_suite_run_id}..."
  SaturnCIWorkerAPI::Request.new(
    host: ENV.fetch('SATURNCI_API_HOST'),
    method: :patch,
    endpoint: "test_suite_runs/#{test_suite_run_id}",
    body: { dry_run_example_count: example_count }.to_json
  ).execute

  puts 'Running tests...'
  test_output_file = '/repository/tmp/test_output.txt'
  FileUtils.mkdir_p(File.dirname(test_output_file))
  File.write(test_output_file, '')

  test_output_stream = SaturnCIWorkerAPI::Stream.new(
    test_output_file,
    "tasks/#{ENV.fetch('TASK_ID')}/test_output",
    wait_interval: 1
  )
  test_output_stream.start

  puts 'Getting test case instructions from server...'
  grouped_test_response = SaturnCIWorkerAPI::Request.new(
    host: ENV.fetch('SATURNCI_API_HOST'),
    method: :post,
    endpoint: "test_suite_runs/#{test_suite_run_id}/targeted_test_cases",
    body: { test_files: Dir.glob('./spec/**/*_spec.rb') }.to_json
  ).execute

  grouped_tests = JSON.parse(grouped_test_response.body)

  rspec_command = [
    'bundle exec rspec',
    '--format documentation',
    '--format documentation --out tmp/test_output.txt',
    '--format json --out tmp/json_output.json',
    '--force-color',
    "--order rand:#{task_info['rspec_seed']}",
    grouped_tests[task_info['run_order_index'].to_s].join(' ')
  ].join(' ')

  docker_command = "docker-compose -f .saturnci/docker-compose.yml run #{DOCKER_SERVICE_NAME} #{rspec_command}"
  puts "Running command: #{docker_command}"
  system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest #{docker_command} 2>&1")
  rspec_exit_code = $CHILD_STATUS.exitstatus

  sleep 2
  test_output_stream.kill

  puts "COMMAND_EXIT_CODE=\"#{rspec_exit_code}\""

  puts 'Sending JSON output...'
  json_output_request = SaturnCIWorkerAPI::FileContentRequest.new(
    host: ENV.fetch('SATURNCI_API_HOST'),
    api_path: "tasks/#{ENV.fetch('TASK_ID')}/json_output",
    content_type: 'application/json',
    file_path: '/repository/tmp/json_output.json'
  )
  response = json_output_request.execute
  puts "JSON output response code: #{response.code}"
  puts response.body

  puts 'Task finished.'
  executor.finish
rescue StandardError => e
  puts "ERROR: #{e.class}: #{e.message}"
  puts e.backtrace.join("\n")
  executor.finish
ensure
  executor.kill_stream
end
