#!/usr/bin/env ruby
# frozen_string_literal: true

require 'English'
require 'fileutils'
require 'json'
require_relative '../../lib/executor'
require_relative '../../lib/test_suite_result'
require_relative '../../lib/dry_run'
require_relative '../../lib/saturn_ci_worker_api/request'
require_relative '../../lib/saturn_ci_worker_api/stream'
require_relative '../../lib/saturn_ci_worker_api/file_content_request'
require_relative '../../lib/saturn_ci_worker_api/test_suite_command'

DOCKER_SERVICE_NAME = 'saturn_test_app'

executor = Executor.new
executor.start_stream

begin
  puts 'Adapter: Ruby on Rails/Rspec'

  executor.clone_repo
  executor.write_env_file

  puts 'Writing RSpec persistence config...'
  persistence_config = <<~RUBY
    RSpec.configure do |config|
      config.example_status_persistence_file_path = 'tmp/rspec_status.txt'
    end
  RUBY
  File.write('.saturnci/rspec_persistence.rb', persistence_config)

  puts 'Copying database.yml...'
  FileUtils.cp('.saturnci/database.yml', 'config/database.yml')

  executor.wait_for_docker
  executor.authenticate_to_registry_cache

  puts 'Building with cache...'
  executor.build_with_cache

  task_info = executor.task_info
  image_url = "docker-image-registry.saturnci.com:5000/#{task_info['project_name']&.downcase}"

  puts 'Pulling image from registry...'
  system("docker pull #{image_url}:latest 2>&1")

  puts 'Running pre.sh...'
  system('chmod +x .saturnci/pre.sh')
  system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest docker-compose -f .saturnci/docker-compose.yml run #{DOCKER_SERVICE_NAME} ./.saturnci/pre.sh 2>&1")

  puts 'Running dry run...'
  dry_run = DryRun.new(docker_service_name: DOCKER_SERVICE_NAME, image_url: "#{image_url}:latest")
  puts "Running dry run command: #{dry_run.command}"
  example_count = dry_run.expected_count
  puts "Expected test count: #{example_count}"

  test_suite_run_id = task_info['test_suite_run_id']
  puts "Setting dry_run_example_count to #{example_count} for test_suite_run #{test_suite_run_id}..."
  SaturnCIWorkerAPI::Request.new(
    host: ENV.fetch('SATURNCI_API_HOST'),
    method: :patch,
    endpoint: "test_suite_runs/#{test_suite_run_id}",
    body: { dry_run_example_count: example_count }.to_json
  ).execute

  puts 'Running tests...'
  test_output_file = '/repository/tmp/test_output.txt'
  FileUtils.mkdir_p(File.dirname(test_output_file))
  File.write(test_output_file, '')

  test_output_stream = SaturnCIWorkerAPI::Stream.new(
    test_output_file,
    "tasks/#{ENV.fetch('TASK_ID')}/test_output",
    wait_interval: 1
  )
  test_output_stream.start

  test_suite_command = SaturnCIWorkerAPI::TestSuiteCommand.new(
    docker_service_name: DOCKER_SERVICE_NAME,
    docker_registry_cache_image_url: "#{image_url}:latest",
    number_of_concurrent_runs: task_info['number_of_concurrent_runs'],
    run_order_index: task_info['run_order_index'],
    rspec_seed: task_info['rspec_seed'],
    rspec_documentation_output_filename: 'tmp/test_output.txt'
  )

  json_output_path = '/repository/tmp/json_output.json'

  puts "Running command: #{test_suite_command.docker_compose_command}"
  system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest #{test_suite_command.docker_compose_command} 2>&1")
  rspec_exit_code = $CHILD_STATUS.exitstatus

  max_retry_passes = 5
  retry_pass = 0

  while rspec_exit_code != 0 && retry_pass < max_retry_passes
    retry_pass += 1
    puts "Retry pass #{retry_pass}/#{max_retry_passes}: re-running failed tests..."

    original_result = TestSuiteResult.new(JSON.parse(File.read(json_output_path)))

    puts "Running retry command: #{test_suite_command.retry_docker_compose_command}"
    system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest #{test_suite_command.retry_docker_compose_command} 2>&1")
    rspec_exit_code = $CHILD_STATUS.exitstatus

    retry_result = TestSuiteResult.new(JSON.parse(File.read(json_output_path)))
    merged_result = original_result.merged_with(retry_result)
    File.write(json_output_path, merged_result.to_json)

    puts "Merged results: #{merged_result.example_count} examples, #{merged_result.failure_count} failures"
  end

  sleep 2
  test_output_stream.kill

  puts "COMMAND_EXIT_CODE=\"#{rspec_exit_code}\""

  puts 'Sending JSON output...'
  json_output_request = SaturnCIWorkerAPI::FileContentRequest.new(
    host: ENV.fetch('SATURNCI_API_HOST'),
    api_path: "tasks/#{ENV.fetch('TASK_ID')}/json_output",
    content_type: 'application/json',
    file_path: json_output_path
  )
  response = json_output_request.execute
  puts "JSON output response code: #{response.code}"
  puts response.body

  puts 'Run finished.'
  executor.finish
rescue StandardError => e
  puts "ERROR: #{e.class}: #{e.message}"
  puts e.backtrace.join("\n")
  executor.finish
ensure
  executor.kill_stream
end
