#!/usr/bin/env ruby
# frozen_string_literal: true

require 'English'
require 'fileutils'
require_relative '../../lib/executor'
require_relative '../../lib/saturn_ci_worker_api/request'
require_relative '../../lib/saturn_ci_worker_api/stream'
require_relative '../../lib/saturn_ci_worker_api/file_content_request'

DOCKER_SERVICE_NAME = 'saturn_test_app'

executor = Executor.new
executor.start_stream

begin
  puts 'Adapter: Ruby on Rails/Rspec'
  executor.send_worker_event('worker_started')

  executor.clone_repo
  executor.send_worker_event('repo_cloned')

  test_suite_run_id = executor.task_info['test_suite_run_id']
  SaturnCIWorkerAPI::Request.new(
    host: ENV.fetch('SATURNCI_API_HOST'),
    method: :patch,
    endpoint: "test_suite_runs/#{test_suite_run_id}",
    body: {
      dockerfile_content: File.read('.saturnci/Dockerfile'),
      docker_compose_file_content: File.read('.saturnci/docker-compose.yml')
    }.to_json
  ).execute

  executor.write_env_file

  puts 'Copying database.yml...'
  FileUtils.cp('.saturnci/database.yml', 'config/database.yml')

  executor.wait_for_docker
  executor.authenticate_to_registry_cache
  executor.preload_compose_images

  puts 'Building with cache...'
  executor.build_with_cache

  task_info = executor.task_info
  image_url = "docker-image-registry-service:5000/#{task_info['project_name']&.downcase}"

  puts 'Image loaded locally by buildx'

  puts 'Setting up database...'
  system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest docker-compose -f .saturnci/docker-compose.yml run --pull=never #{DOCKER_SERVICE_NAME} bundle exec rails db:create db:schema:load 2>&1")
  executor.send_worker_event('database_setup_finished')

  puts 'Precompiling assets...'
  system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest docker-compose -f .saturnci/docker-compose.yml run --pull=never #{DOCKER_SERVICE_NAME} bundle exec rails assets:precompile 2>&1")
  executor.send_worker_event('assets_precompiled')

  test_suite_run_id = task_info['test_suite_run_id']

  puts 'Running dry run to get test case identifiers...'
  command = "SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest docker-compose -f .saturnci/docker-compose.yml run --pull=never #{DOCKER_SERVICE_NAME} bundle exec rspec --dry-run --format json ./spec"
  puts 'Command:'
  puts command
  dry_run_json = `#{command}`
  test_case_identifiers = JSON.parse(dry_run_json)['examples'].map { |example| example['id'] }
  puts "Found #{test_case_identifiers.count} test cases"
  executor.send_worker_event('dry_run_finished')

  puts 'Running tests...'
  test_output_file = '/repository/tmp/test_output.txt'
  FileUtils.mkdir_p(File.dirname(test_output_file))
  File.write(test_output_file, '')

  test_output_stream = SaturnCIWorkerAPI::Stream.new(
    test_output_file,
    "tasks/#{ENV.fetch('TASK_ID')}/test_output",
    wait_interval: 1
  )
  test_output_stream.start

  puts 'Getting test case instructions from server...'
  test_set_response = SaturnCIWorkerAPI::Request.new(
    host: ENV.fetch('SATURNCI_API_HOST'),
    method: :post,
    endpoint: "test_suite_runs/#{test_suite_run_id}/test_set",
    body: { test_files: test_case_identifiers }.to_json
  ).execute

  test_set_data = JSON.parse(test_set_response.body)
  grouped_tests = test_set_data['grouped_tests']
  dry_run_example_count = test_set_data['dry_run_example_count']
  executor.send_worker_event('test_set_received')

  raise 'dry_run_example_count not set by server' if dry_run_example_count.nil?

  puts "dry_run_example_count: #{dry_run_example_count}"

  rspec_command = [
    'bundle exec rspec',
    '--format documentation',
    '--format documentation --out tmp/test_output.txt',
    '--format json --out tmp/json_output.json',
    '--force-color',
    "--order rand:#{task_info['rspec_seed']}",
    grouped_tests[task_info['run_order_index'].to_s].join(' ')
  ].join(' ')

  docker_command = "docker-compose -f .saturnci/docker-compose.yml run --pull=never #{DOCKER_SERVICE_NAME} #{rspec_command}"
  puts "Running command: #{docker_command}"
  executor.send_worker_event('tests_started')
  system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest #{docker_command} 2>&1")
  rspec_exit_code = $CHILD_STATUS.exitstatus
  executor.send_worker_event('tests_finished')

  sleep 2
  test_output_stream.kill

  puts "COMMAND_EXIT_CODE=\"#{rspec_exit_code}\""

  puts 'Sending JSON output...'
  json_output_request = SaturnCIWorkerAPI::FileContentRequest.new(
    host: ENV.fetch('SATURNCI_API_HOST'),
    api_path: "tasks/#{ENV.fetch('TASK_ID')}/json_output",
    content_type: 'application/json',
    file_path: '/repository/tmp/json_output.json'
  )
  response = json_output_request.execute
  puts "JSON output response code: #{response.code}"
  puts response.body

  puts 'Task finished.'
  executor.finish
rescue StandardError => e
  puts "ERROR: #{e.class}: #{e.message}"
  puts e.backtrace.join("\n")
  executor.finish
ensure
  executor.kill_stream
end
