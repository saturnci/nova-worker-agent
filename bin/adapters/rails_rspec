#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../../lib/executor'

executor = Executor.new
executor.start_stream
puts 'Adapter: Ruby on Rails/Rspec'

executor.clone_repo
executor.write_env_file
executor.wait_for_docker

puts 'Building with cache...'
unless executor.build_with_cache
  puts 'Falling back to docker-compose build...'
  system('docker-compose -f .saturnci/docker-compose.yml build 2>&1')
end

puts 'Run finished.'
executor.finish
executor.kill_stream
