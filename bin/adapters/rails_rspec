#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../../lib/executor'
require_relative '../../lib/saturn_ci_worker_api/request'

DOCKER_SERVICE_NAME = 'saturn_test_app'

executor = Executor.new
executor.start_stream
puts 'Adapter: Ruby on Rails/Rspec'

executor.clone_repo
executor.write_env_file
executor.wait_for_docker

puts 'Building with cache...'
executor.build_with_cache

task_info = executor.task_info
image_url = "registrycache.saturnci.com:5000/#{task_info['project_name']&.downcase}"

puts 'Pulling image from registry...'
system("docker pull #{image_url}:latest 2>&1")

puts 'Running pre.sh...'
system('chmod +x .saturnci/pre.sh')
system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest docker-compose -f .saturnci/docker-compose.yml run #{DOCKER_SERVICE_NAME} ./.saturnci/pre.sh 2>&1")

puts 'Running tests...'
system("SATURN_TEST_APP_IMAGE_URL=#{image_url}:latest docker-compose -f .saturnci/docker-compose.yml run #{DOCKER_SERVICE_NAME} bundle exec rspec 2>&1")

test_suite_run_id = task_info['test_suite_run_id']
puts "Setting dry_run_example_count to 0 for test_suite_run #{test_suite_run_id}..."
SaturnCIWorkerAPI::Request.new(
  host: ENV.fetch('SATURNCI_API_HOST'),
  method: :patch,
  endpoint: "test_suite_runs/#{test_suite_run_id}",
  body: { dry_run_example_count: 0 }.to_json
).execute

puts 'Run finished.'
executor.finish
executor.kill_stream
